version: 1.0.0.{build}
image: Visual Studio 2017 Preview
environment:
  AZ_AD_SP_ID: http://musicbotsvc
  AZ_AD_TENANT: 46947e84-c7c5-4572-bf44-0c0b2d9013b8
  AZ_AD_SP_PASS:
    secure: QBSDpMZyT8QNWCo1R8M6o7+Umvo61xZjMnRIAp2a/eM=
  AZ_LOCATION: eastus
  AZ_RG_BUILD: MUSIC-BOT-BUILD
  AZ_RG_DEV: MUSIC-BOT-DEV
  AZ_RG_INT_PREFIX: MUSIC-BOT-INT-
  AZ_RG_PROD: MUSIC-BOT-PROD
  DEV_PUBLISH_URL:
before_build:
  - ps: $pass = ConvertTo-SecureString $env:AZ_AD_SP_PASS -AsPlainText -Force
  - ps: $cred = New-Object -TypeName pscredential –ArgumentList $env:AZ_AD_SP_ID, $pass
  - ps: Login-AzureRmAccount -Credential $cred -ServicePrincipal -TenantId $env:AZ_AD_TENANT
build_script: 
  - nuget restore
  - msbuild MusicBot.Backend.sln /p:Configuration=Release /logger:"C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll" /p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="MusicBot-Functions.zip"
  - ps: ./src/arm/Deploy-AzureResourceGroup.ps1 -ArtifactStagingDirectory src/arm -ResourceGroupLocation $env:AZ_LOCATION -ResourceGroupName $env:AZ_RG_INT_PREFIX$env:APPVEYOR_BUILD_NUMBER
  - ps: if ($LastExitCode -ne 0) { $host.SetShouldExit($LastExitCode) }
on_finish:
  - ps: Start-Job -ScriptBlock { Remove-AzureRmResourceGroup -Name $env:AZ_RG_INT_PREFIX$env:APPVEYOR_BUILD_NUMBER -Force }
deploy:
  - provider: WebDeploy
    server: https://music-bot-dev-app.scm.azurewebsites.net:443/MsDeploy.axd?Site=MUSIC-BOT-DEV-APP
    website: MUSIC-BOT-DEV-APP
    username: $MUSIC-BOT-DEV-APP
    password:
      secure: 4YuhAwTFo/5yD/5s9yIqm4bTScD8K19sbKcKLgfO6d0SbOCE/Di0FwwNPhU2HA92GppbjPV3n+ml5rSJFLD4pg==
    ntlm: false
    remove_files: true
    artifact: Functions App
    on:
      branch: master
artifacts:
  - path: src/arm
    name: ARM Templates
  - path: src/func/MusicBot-Functions.zip
    name: Functions App
